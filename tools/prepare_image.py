"""
–£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –º–æ–¥—É–ª—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–∫.

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ –±–æ—Ç–µ
- –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫ –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Ä–∞–∑–º–µ—Ä–∞–º
- –û—Ç—Å–µ–≤ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞

–ú–æ–¥—É–ª—å –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram-–±–æ—Ç–µ.
–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî –ø—Ä–∏:
- –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–±–æ—Ä–∞ —Ñ–æ–Ω–æ–≤

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –ë–µ—Ä—ë—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ assets/images
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
3. –£–º–µ–Ω—å—à–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ assets/previews
5. –ò—Å—Ö–æ–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç

–§–æ—Ä–º–∞—Ç:
- –í—Ö–æ–¥: JPG / JPEG / PNG
- –í—ã—Ö–æ–¥: JPEG (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

–ú–æ–¥—É–ª—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∫ standalone-—Å–∫—Ä–∏–ø—Ç.
"""

from pathlib import Path
from PIL import Image

# ===== PATHS =====
BASE_DIR = Path(__file__).resolve().parent.parent
SRC_DIR = BASE_DIR / "assets" / "images"
DST_DIR = BASE_DIR / "assets" / "previews"

DST_DIR.mkdir(parents=True, exist_ok=True)

# ===== SETTINGS =====
MIN_SIDE = 320
MAX_SIDE = 1280
ALLOWED_EXT = (".jpg", ".jpeg", ".png")


def prepare_image(src_path: Path) -> Path | None:
    """
       –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ.

       –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
       - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç–æ—Ä–æ–Ω
       - –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

       –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
       - —É–º–µ–Ω—å—à–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
       - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ RGB
       - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ JPEG

       –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
       - src_path: –ø—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é

       –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
       - –ø—É—Ç—å –∫ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
       - None, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—à–ª–æ –ø—Ä–æ–≤–µ—Ä–∫—É –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
       """
    try:
        img = Image.open(src_path)
        img = img.convert("RGB")
        w, h = img.size

        # ‚ùå —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ
        if min(w, h) < MIN_SIDE:
            print(f"SKIP (too small): {src_path.name}")
            return None

        # üîß —É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        scale = min(MAX_SIDE / w, MAX_SIDE / h, 1)
        new_w = int(w * scale)
        new_h = int(h * scale)

        if scale < 1:
            img = img.resize((new_w, new_h), Image.LANCZOS)

        out_path = DST_DIR / src_path.name
        img.save(out_path, format="JPEG", quality=90, optimize=True)

        print(f"OK: {src_path.name} -> {new_w}x{new_h}")
        return out_path

    except Exception as e:
        print(f"ERROR: {src_path.name} -> {e}")
        return None


def main():
    """
       –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

       –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ assets/images
       –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—Ç–µ.

       –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
       - –ø–µ—Ä–≤–∏—á–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤
       - –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
       """
    images = [
        p for p in SRC_DIR.iterdir()
        if p.suffix.lower() in ALLOWED_EXT
    ]

    print(f"Found images: {len(images)}")

    prepared = 0
    for img_path in images:
        if prepare_image(img_path):
            prepared += 1

    print(f"Prepared images: {prepared}")


if __name__ == "__main__":
    main()